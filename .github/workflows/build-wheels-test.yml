name: Test Build Wheels (No Publish)

# This workflow builds wheels for testing but does NOT publish to PyPI
# Use this for pull requests, development branches, or manual testing

on:
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:  # Allow manual triggering
    inputs:
      platforms:
        description: 'Platforms to build (comma-separated: linux,macos-intel,macos-arm,windows)'
        required: false
        default: 'linux'
        type: string

permissions:
  contents: read

jobs:
  test_pre_checks:
    name: Test Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.platforms.outputs.build_linux }}
      build_macos_intel: ${{ steps.platforms.outputs.build_macos_intel }}
      build_macos_arm: ${{ steps.platforms.outputs.build_macos_arm }}
      build_windows: ${{ steps.platforms.outputs.build_windows }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Determine platforms to build
        id: platforms
        run: |
          PLATFORMS="${{ github.event.inputs.platforms || 'linux' }}"
          
          echo "build_linux=$([[ $PLATFORMS == *"linux"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "build_macos_intel=$([[ $PLATFORMS == *"macos-intel"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "build_macos_arm=$([[ $PLATFORMS == *"macos-arm"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "build_windows=$([[ $PLATFORMS == *"windows"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          
          echo "Building for platforms: $PLATFORMS"
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine setuptools wheel
      
      - name: Validate package structure
        run: |
          if [[ ! -f "setup.py" ]] && [[ ! -f "pyproject.toml" ]]; then
            echo "::error::Neither setup.py nor pyproject.toml found!"
            exit 1
          fi
          echo "âœ“ Build configuration found"
      
      - name: Validate package metadata
        run: |
          python -m build --sdist --outdir /tmp/sdist-check
          python -m twine check /tmp/sdist-check/*
          echo "âœ“ Package metadata is valid"
      
      - name: Check Python syntax
        run: |
          python -m py_compile $(find . -name "*.py" ! -path "./build/*" ! -path "./dist/*" ! -path "./.venv/*")
          echo "âœ“ Python syntax is valid"

  test_build_linux:
    name: Test Build - Linux
    needs: test_pre_checks
    if: needs.test_pre_checks.outputs.build_linux == 'true'
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.21.3
      
      - name: Configure wheel platform tag
        run: |
          cat > setup.cfg << EOF
          [bdist_wheel]
          plat_name = manylinux_2_17_x86_64
          EOF
      
      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: cp311-* cp312-* cp313-*
          CIBW_SKIP: "*-manylinux_i686 *-musllinux_*"
          CIBW_BEFORE_BUILD: pip install Cython>=0.29.0
          CIBW_TEST_REQUIRES: pytest numpy scipy
          CIBW_TEST_COMMAND: python -c "from q_store import QuantumDatabase; print('âœ“ Import test passed')"
          CIBW_ARCHS_LINUX: "x86_64"
      
      - name: List built wheels
        run: |
          ls -lh wheelhouse/
          echo "âœ“ Linux wheels built successfully"
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-wheels-linux
          path: ./wheelhouse/*.whl
          retention-days: 7

  test_build_macos_intel:
    name: Test Build - macOS Intel
    needs: test_pre_checks
    if: needs.test_pre_checks.outputs.build_macos_intel == 'true'
    runs-on: macos-12
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.21.3
      
      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: cp311-* cp312-* cp313-*
          CIBW_BEFORE_BUILD: pip install Cython>=0.29.0
          CIBW_TEST_REQUIRES: pytest numpy scipy
          CIBW_TEST_COMMAND: python -c "from q_store import QuantumDatabase; print('âœ“ Import test passed')"
          CIBW_ARCHS_MACOS: "x86_64"
      
      - name: List built wheels
        run: |
          ls -lh wheelhouse/
          echo "âœ“ macOS Intel wheels built successfully"
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-wheels-macos-intel
          path: ./wheelhouse/*.whl
          retention-days: 7

  test_build_macos_arm:
    name: Test Build - macOS ARM64
    needs: test_pre_checks
    if: needs.test_pre_checks.outputs.build_macos_arm == 'true'
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.21.3
      
      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: cp311-* cp312-* cp313-*
          CIBW_BEFORE_BUILD: pip install Cython>=0.29.0
          CIBW_TEST_REQUIRES: pytest numpy scipy
          CIBW_TEST_COMMAND: python -c "from q_store import QuantumDatabase; print('âœ“ Import test passed')"
          CIBW_ARCHS_MACOS: "arm64"
      
      - name: List built wheels
        run: |
          ls -lh wheelhouse/
          echo "âœ“ macOS ARM64 wheels built successfully"
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-wheels-macos-arm
          path: ./wheelhouse/*.whl
          retention-days: 7

  test_build_windows:
    name: Test Build - Windows
    needs: test_pre_checks
    if: needs.test_pre_checks.outputs.build_windows == 'true'
    runs-on: windows-2022
    timeout-minutes: 90
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.21.3
      
      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: cp311-* cp312-* cp313-*
          CIBW_SKIP: "*-win32"
          CIBW_BEFORE_BUILD: pip install Cython>=0.29.0
          CIBW_TEST_REQUIRES: pytest numpy scipy
          CIBW_TEST_COMMAND: python -c "from q_store import QuantumDatabase; print('âœ“ Import test passed')"
          CIBW_ARCHS_WINDOWS: "AMD64"
          CIBW_ENVIRONMENT: "CL=/O2 /GL /MP"
      
      - name: List built wheels
        shell: bash
        run: |
          ls -lh wheelhouse/
          echo "âœ“ Windows wheels built successfully"
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-wheels-windows
          path: ./wheelhouse/*.whl
          retention-days: 7

  test_summary:
    name: Test Build Summary
    needs: [test_pre_checks, test_build_linux, test_build_macos_intel, test_build_macos_arm, test_build_windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Test Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This was a **test build** - no packages were published." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test_pre_checks.outputs.build_linux }}" == "true" ]]; then
            echo "- Linux: ${{ needs.test_build_linux.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test_pre_checks.outputs.build_macos_intel }}" == "true" ]]; then
            echo "- macOS Intel: ${{ needs.test_build_macos_intel.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test_pre_checks.outputs.build_macos_arm }}" == "true" ]]; then
            echo "- macOS ARM64: ${{ needs.test_build_macos_arm.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test_pre_checks.outputs.build_windows }}" == "true" ]]; then
            echo "- Windows: ${{ needs.test_build_windows.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "To publish these wheels, create a new version tag:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'git tag v1.0.0' >> $GITHUB_STEP_SUMMARY
          echo 'git push origin v1.0.0' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
