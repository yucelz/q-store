name: Release and Publish

on:
  workflow_run:
    workflows:
      - "Build Linux Wheels"
      - "Build Windows Wheels"
      - "Build macOS Intel Wheels"
      - "Build macOS ARM64 Wheels"
    types:
      - completed
  workflow_dispatch:  # Allow manual triggering
    inputs:
      tag:
        description: 'Tag to release (e.g., v4.1.0)'
        required: true
        type: string
      skip_build_check:
        description: 'Skip checking all builds completed (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  check_builds:
    name: Check all builds completed successfully
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      tag_name: ${{ steps.extract_tag.outputs.tag_name }}
      version: ${{ steps.extract_tag.outputs.version }}
      is_prerelease: ${{ steps.extract_tag.outputs.is_prerelease }}

    steps:
      - name: Extract tag from triggering workflow
        id: extract_tag
        run: |
          # Handle manual dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
            echo "Manual trigger for tag: $TAG_NAME"
          else
            # Get the head branch from the triggering workflow run
            TAG_NAME="${{ github.event.workflow_run.head_branch }}"
            echo "Automatic trigger for tag: $TAG_NAME"
          fi

          if [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            VERSION="${TAG_NAME#v}"
            echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT

            # Check if prerelease
            if [[ $VERSION =~ (alpha|beta|rc|dev) ]]; then
              echo "is_prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "is_prerelease=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Not a version tag, skipping release"
            exit 0
          fi

      - name: Check if all builds completed
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.extract_tag.outputs.tag_name }}"

          if [ -z "$TAG" ]; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Skip build check if manually requested
          if [[ "${{ github.event.inputs.skip_build_check }}" == "true" ]]; then
            echo "âš  Skipping build check as requested"
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Checking builds for tag: $TAG"

          # Get all workflow runs for this tag
          RUNS=$(gh api "/repos/${{ github.repository }}/actions/runs?event=push&head_sha=$(gh api /repos/${{ github.repository }}/git/ref/tags/$TAG --jq '.object.sha')" --jq '.workflow_runs')

          # Check if we have all 4 build workflows completed successfully
          LINUX_STATUS=$(echo "$RUNS" | jq -r '.[] | select(.name == "Build Linux Wheels") | .conclusion' | head -1)
          WINDOWS_STATUS=$(echo "$RUNS" | jq -r '.[] | select(.name == "Build Windows Wheels") | .conclusion' | head -1)
          MACOS_INTEL_STATUS=$(echo "$RUNS" | jq -r '.[] | select(.name == "Build macOS Intel Wheels") | .conclusion' | head -1)
          MACOS_ARM_STATUS=$(echo "$RUNS" | jq -r '.[] | select(.name == "Build macOS ARM64 Wheels") | .conclusion' | head -1)

          echo "Linux: $LINUX_STATUS"
          echo "Windows: $WINDOWS_STATUS"
          echo "macOS Intel: $MACOS_INTEL_STATUS"
          echo "macOS ARM: $MACOS_ARM_STATUS"

          # Check if at least 3 major platforms succeeded (allow skipping one)
          SUCCESS_COUNT=0
          [[ "$LINUX_STATUS" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [[ "$WINDOWS_STATUS" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [[ "$MACOS_ARM_STATUS" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [[ "$MACOS_INTEL_STATUS" == "success" ]] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))

          if [[ $SUCCESS_COUNT -ge 3 ]]; then
            echo "âœ“ At least 3 platforms completed successfully ($SUCCESS_COUNT/4)"
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "âš  Not enough builds completed: $SUCCESS_COUNT/4 succeeded"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  release_and_publish:
    name: Create Release and Publish to PyPI
    needs: check_builds
    runs-on: ubuntu-latest
    if: needs.check_builds.outputs.should_release == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.check_builds.outputs.tag_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheels-*
          merge-multiple: true

      - name: List downloaded wheels
        run: |
          echo "=== Downloaded Wheels ==="
          ls -lh dist/ || echo "No dist/ directory found"
          if [ -d dist ]; then
            WHEEL_COUNT=$(ls -1 dist/*.whl 2>/dev/null | wc -l || echo "0")
            echo ""
            echo "Total wheels: $WHEEL_COUNT"

            if [ $WHEEL_COUNT -gt 0 ]; then
              echo ""
              echo "By platform:"
              ls -1 dist/*.whl | sed 's/.*-\(.*\)\.whl/\1/' | sort | uniq -c
            fi
          fi

      - name: Verify minimum wheels exist
        run: |
          # We expect at least 9 wheels (3 Python versions Ã— 3 main platforms)
          MIN_WHEELS=9
          ACTUAL_COUNT=$(ls -1 dist/*.whl 2>/dev/null | wc -l || echo "0")

          if [ $ACTUAL_COUNT -lt $MIN_WHEELS ]; then
            echo "::error::Expected at least $MIN_WHEELS wheels, found $ACTUAL_COUNT"
            echo "Artifacts may still be uploading. Waiting 60 seconds..."
            sleep 60

            # Re-download artifacts
            echo "Re-downloading artifacts..."

            # Re-check
            ACTUAL_COUNT=$(ls -1 dist/*.whl 2>/dev/null | wc -l || echo "0")
            if [ $ACTUAL_COUNT -lt $MIN_WHEELS ]; then
              echo "::error::Still only found $ACTUAL_COUNT wheels after waiting"
              ls -la dist/ || true
              exit 1
            fi
          fi

          echo "âœ“ Found $ACTUAL_COUNT wheels"

      - name: Install twine
        run: python -m pip install --upgrade twine

      - name: Check package distributions
        run: |
          python -m twine check dist/*.whl
          echo "âœ“ All wheels passed twine check"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check_builds.outputs.tag_name }}
          files: dist/*.whl
          draft: false
          prerelease: ${{ needs.check_builds.outputs.is_prerelease }}
          generate_release_notes: true
          name: Release ${{ needs.check_builds.outputs.tag_name }}
          body: |
            ## Wheels for version ${{ needs.check_builds.outputs.version }}

            This release includes pre-built wheels for:
            - **Linux**: manylinux x86_64 (Python 3.11, 3.12, 3.13)
            - **Windows**: AMD64 (Python 3.11, 3.12, 3.13)
            - **macOS**: Intel x86_64 (Python 3.11, 3.12, 3.13)
            - **macOS**: ARM64 (Python 3.11, 3.12, 3.13)

            ### Installation
            ```bash
            pip install q-store==${{ needs.check_builds.outputs.version }}
            ```

            See the full changelog below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          # Use --skip-existing to handle race conditions gracefully
          python -m twine upload dist/*.whl --skip-existing --verbose

      - name: Verify PyPI upload
        run: |
          echo "Package should be available at:"
          echo "https://pypi.org/project/q-store/${{ needs.check_builds.outputs.version }}/"

          # Wait a bit for PyPI to process
          sleep 10

          # Try to fetch package info
          pip index versions q-store | head -n 5 || true

      - name: Generate summary
        run: |
          echo "## ðŸŽ‰ Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.check_builds.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.check_builds.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Prerelease:** ${{ needs.check_builds.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- PyPI: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI Package](https://pypi.org/project/q-store/${{ needs.check_builds.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.check_builds.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY
