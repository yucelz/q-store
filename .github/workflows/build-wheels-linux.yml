name: Build Linux Wheels

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v3.4.0
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read

jobs:
  # Pre-flight checks before building
  pre_checks:
    name: Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}
            echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT

            # Check if prerelease (contains alpha, beta, rc, dev)
            if [[ $VERSION =~ (alpha|beta|rc|dev) ]]; then
              echo "is_prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "is_prerelease=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "tag_name=manual-build" >> $GITHUB_OUTPUT
            echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc|dev)\.[0-9]+)?$ ]]; then
            echo "::warning::Version format may not be standard: $VERSION"
          fi
          echo "✓ Version: $VERSION"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine setuptools wheel

      - name: Check if setup.py/pyproject.toml exists
        run: |
          if [[ ! -f "setup.py" ]] && [[ ! -f "pyproject.toml" ]]; then
            echo "::error::Neither setup.py nor pyproject.toml found!"
            exit 1
          fi
          echo "✓ Build configuration found"

      - name: Validate package metadata
        run: |
          # Try to build source distribution to validate metadata
          python -m build --sdist --outdir /tmp/sdist-check
          python -m twine check /tmp/sdist-check/*
          echo "✓ Package metadata is valid"

      - name: Check for required files
        run: |
          FILES_TO_CHECK="README.md LICENCE __init__.py"
          for file in $FILES_TO_CHECK; do
            if [[ -f "$file" ]] || find . -name "$file" -type f | grep -q .; then
              echo "✓ Found: $file"
            else
              echo "::warning::Missing: $file"
            fi
          done

  # Build Linux wheels
  build_linux:
    name: Build Linux wheels
    needs: pre_checks
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.21.3

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: cp311-* cp312-* cp313-*
          CIBW_SKIP: "*-manylinux_i686 *-musllinux_*"
          CIBW_BEFORE_BUILD: "pip install Cython>=0.29.0 && pip install --only-binary=:all: pyarrow>=14.0.0"
          CIBW_TEST_REQUIRES: pytest numpy scipy
          CIBW_TEST_COMMAND: python -c "from q_store import QuantumDatabase; print('Import successful!')"
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014

      - name: Verify wheels were built
        run: |
          if [ -z "$(ls -A wheelhouse/*.whl 2>/dev/null)" ]; then
            echo "::error::No wheels were built!"
            exit 1
          fi
          ls -lh wheelhouse/
          echo "✓ Linux wheels built successfully"

          # Verify platform tags
          for wheel in wheelhouse/*.whl; do
            echo "Checking: $(basename $wheel)"
            if [[ ! $(basename $wheel) =~ manylinux ]]; then
              echo "::error::Wheel has incorrect platform tag: $(basename $wheel)"
              exit 1
            fi
          done

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-x86_64
          path: ./wheelhouse/*.whl
          retention-days: 30
          if-no-files-found: error
